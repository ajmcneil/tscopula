---
title: "Models with Margins"
author: "Alexander J. McNeil and Martin Bladt"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Models with Margins}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tscopulaplus)
library(stats4)
```

## VT-D-Vine Process (Second kind) with Skewed Laplace Margin 

### Construction

```{r}
copmod <- dvinecopula2(family = "joe",
                       kpacf = "kpacf_arma",
                       pars = list(ar = 0.9, ma = -0.8),
                       maxlag = 30)
vcopmod <- vtscopula(copmod,
                     Vtransform = V2p(delta = 0.5, kappa = 2))
margmod <- margin("slaplace",
                  pars = c(mu = 1, scale = 2, gamma = 0.7))
tscmmod <- tscm(vcopmod, margmod)
tscmmod
```

### Simulation

```{r, fig.show='hold', fig.width = 6, fig.height = 3, dev.args =list(pointsize=9)}
set.seed(13)
data2 <- sim(tscmmod, n= 2000)
hist(data2)
ts.plot(data2)
```

### Estimation

First fit a marginal model only. 

```{r}
margfit <- fit(margmod, data2)
```

Now fit the time series copula model stepwise.

```{r}
tscmfit_step <- fit(tscmmod, data2)
tscmfit_step
coef(tscmfit_step)
coef(tscmmod)
```

Final optimization over all parameters.

```{r}
tscmfit_full <- fit(tscmfit_step, data2, method = "full")
tscmfit_full
```

Comparison of model.

```{r}
AIC(margfit, tscmfit_step, tscmfit_full)
```

### Plotting

We can plot the estimated v-transform and well as the goodness-of-fit plots for the `dvinecopula` object based on Kendall rank correlations.

The first plots relate to the fitted copula.

```{r, fig.show='hold', dev.args =list(pointsize=9)}
plot(tscmfit_full, plotoption = 1)
plot(tscmfit_full, plotoption = 2)
```

The next plot is the QQplot of the marginal fit.

```{r, fig.show='hold', dev.args =list(pointsize=9)}
plot(tscmfit_full, plottype = "margin")
```

The next two plots are the estimated v-transform and the estimated volatility profile function.

```{r, fig.show='hold', dev.args =list(pointsize=9)}
plot(tscmfit_full, plottype = "vtransform")
plot(tscmfit_full, plottype = "volprofile")
```

The final two plots show aspect of the fit of the v-transform to the data.

```{r, fig.show='hold', dev.args =list(pointsize=9)}
plot(tscmfit_full, plottype = "volproxy")
plot(tscmfit_full, plotoption = 2, plottype = "volproxy")
```



