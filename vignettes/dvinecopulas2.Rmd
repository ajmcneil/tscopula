---
title: "D-Vine and VT-D-Vine Copula Processes of Second Kind"
author: "Alexander J. McNeil and Martin Bladt"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{D-Vine and VT-D-Vine Copula Processes of Second Kind}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tscopulaplus)
library(stats4)
```

## D-Vine Copula Processes (of second kind)

### Construction

We construct a model using the Joe copula and the Kendall partial autocorrelation function (KPACF) of a Gaussian ARMA process with autogressive (ar) parameter 0.9 and moving average (ma) parameter -0.85. The KPACF is truncated at lag 30, so this is a process of finite order. We can also set $\text{maxlag} = \inf$ but this leads to much slower simulation.

```{r}
copmod <- dvinecopula2(family = "joe",
                       kpacf = "kpacf_arma",
                       pars = list(ar = 0.9, ma = -0.85),
                       maxlag = 30)
copmod
```

### Simulation

A realization can be generated with the generic command `sim`.

```{r, fig.show='hold', fig.width = 6, fig.height = 3, dev.args =list(pointsize=9)}
set.seed(13)
data1 <- sim(copmod, n = 2000)
hist(data1)
ts.plot(data1)
```

### Estimation 

A model spec can be fitted to data with the generic command `fit`.

```{r}
copspec_Gauss <- dvinecopula2(family = "gauss",
                              pars = list(ar = 0, ma = 0),
                              maxlag = 30)
fitGauss <- fit(copspec_Gauss, data1)
fitGauss

copspec_Joe <- dvinecopula2(family = "joe",
                            pars = list(ar = 0, ma = 0),
                            maxlag = 30)
fitJoe <- fit(copspec_Joe, data1)
fitJoe

AIC(fitGauss, fitJoe)
```

### Plotting

Various plots are generated by the generic command `plot`. The plots are as follows:

1. Empirical Kendall's tau values from generalized lagged data (black bars) and theoretical Kendall's tau values for estimated copula (red line).
2. Kendall partial autocorrelation function if the data $(\Phi^{-1}(u_t))$ were from Gaussian process (black bars), empirical Kendall's tau values from generalized lagged data (black line) and theoretical Kendall's tau values for estimated copula (red line).
3. Generalized lag plot.

```{r, fig.show='hold', dev.args =list(pointsize=9)}
plot(fitJoe, plotoption = 1)
plot(fitJoe, plotoption = 2)
```

## VT-D-Vine Copula Processes

VT-D-Vine processes are created by adding a v-transform to an `dvinecopula` object using the command `vtscopula`. The generic commands `sim`, `fit` and `plot` also work for these processes.

### Construction

We add a 2-parameter V-transform.

```{r}
vcopmod <- vtscopula(copmod,
  Vtransform = V2p(delta = 0.55, kappa = 0.8)
)
vcopmod
```

### Simulation

```{r, fig.show='hold', fig.width = 6, fig.height = 3, dev.args =list(pointsize=9)}
set.seed(13)
data2 <- sim(vcopmod, n = 2000)
hist(data2)
ts.plot(data2)
```

### Estimation

```{r}
vcopspec <- vtscopula(copspec_Joe, V2p())
vcopfit <- fit(vcopspec, data2, 
               tsoptions = list(hessian = TRUE),
               control = list(maxit = 1000))
vcopfit
coef(vcopfit)
coef(vcopmod)
```

### Plotting

We can plot the estimated v-transform and well as the goodness-of-fit plots for the `dvinecopula` object based on Kendall rank correlations.

```{r, fig.show='hold', dev.args =list(pointsize=9)}
plot(vcopfit, plottype = "vtransform")
plot(vcopfit, plotoption = 1)
plot(vcopfit, plotoption = 2)
```

### Resimulation of fitted model

Note that we can easily simulate data from the fitted model using the following code.

```{r}
data2b <- sim(vcopfit, 1000)
ts.plot(data2b)
```


